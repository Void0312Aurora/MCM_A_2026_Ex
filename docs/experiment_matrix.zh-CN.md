# 标准实验矩阵（v1，最小可辨识）

更新时间：2026-01-31

目标：把“必须测什么、怎么测、验收标准是什么”一次性定死，避免后续数据不可比、不可解释；并以**最小实验量**覆盖题目要求（screen/cpu/net/gps/background/temperature + TTE/敏感性/建议）。

核心原则：
- 不追求消灭所有噪声；追求**固定条件** + **明确记录** + **可验收**。
- 所有实验都必须能回答一个明确的参数/子模块问题（例如屏幕功耗曲线、基线功耗）。
- 对照实验只做“最小必要”的：只有当某个因素会系统性改变结论（量级接近或大于目标增量）才考虑加做一条短对照。

---

## 0. 全局固定项（每次都要执行/记录）

### 0.1 固定设置（尽量固定；做不到就记录）
- 亮度模式：关闭自动亮度（固定为手动）。
- 刷新率/省电模式：固定（开/关都行，但必须一致）。
- 音量/蓝牙/NFC：固定（建议关）。
- 前台应用：固定（建议停留在桌面或同一静态界面）。
- 屏幕超时：S2 需要屏幕常亮（手动设置为“永不”或足够长）。

网络相关需要拆成两层，否则“对照”会无限膨胀：

- 组网拓扑（连接方式，影响是否由手机承担 AP 功耗）：
  - Topo-1：手机热点开，电脑连手机热点（最方便无线调试，但通常更耗电）。
  - Topo-2：电脑开热点/路由器 Wi‑Fi，手机连接（手机不做 AP，通常更省电）。
- 网络模式（题面关心的使用情景）：
  - Net-0：飞行模式（网络关闭）。
  - Net-1：Wi‑Fi（连接路由器或电脑热点均可，但请在同一实验序列内保持一致）。
  - Net-2：蜂窝数据（LTE/5G，信号强弱会影响功耗，必须记录）。

### 0.2 记录元数据（每条 run 都要写在 note/旁注里）
- 组网拓扑：Topo-1/Topo-2。
- 网络模式：Net-0/Net-1/Net-2（并注明信号强弱，如果肉眼可见）。
- 屏幕：on/off；亮度值（0–255）；是否 AOD。
- 关键开关：热点/蓝牙/GPS/省电模式/高刷。
- 设备温度大致范围（开跑前看一次 thermalservice）。

---

## 1. 必须测的“最小集合”（v1，贴题且不冗余）

v1 目标：用**最小可辨识**的实验集合，完成题目要求的闭环：
- 连续时间模型 + 参数估计（不靠离散回归）
- 多情景 TTE（至少覆盖飞行/Wi‑Fi/蜂窝 + 屏幕亮度变化 + GPS + CPU负载量级）
- 不确定性/敏感性（基于已校准参数做扰动分析）
- 建议（用户行为与 OS 策略可量化）

原则：每新增一个功耗项，只补一条能识别该项量级/参数的最小实验；其余随机扰动作为残差处理。

### S0：仪器自检（必做，5–8 分钟）
- 目的：验证无线 ADB 稳定、charge_counter 是否有分辨率、热读数是否正常。
- 条件：按你之后要做的网络条件来（例如热点开就一直开）。
- 时长：5–8 分钟。
- 验收：
  - `adb_error` 全为 0；
  - `battery_updates_stopped=0`；
  - `dt_s` 大致接近采样间隔；
  - thermal 列能出值（若开启了 `--thermal`）。

### S1：基线（屏幕关，按网络模式分 2–3 条）

> 这是题面“网络活动导致差异”的最低成本实现：不用做无穷对照，只需把网络模式作为离散状态项。

- S1-0（Net-0 飞行模式）：屏幕关，15–20 分钟。
  - 估计最干净的 `P_base`（后台 + 系统底噪）。
- S1-1（Net-1 Wi‑Fi）：屏幕关，15–20 分钟。
  - 估计 `P_net(Wi‑Fi)` 的增量。
- S1-2（Net-2 蜂窝，可选但更贴题）：屏幕关，15–20 分钟。
  - 估计 `P_net(Cell)` 的增量；记录信号强弱。

验收：同 S0。

### S2：屏幕功耗（亮度阶梯，推荐拆成多条短 run）

> 为了严谨且不需要手动记录“切档时间点”，推荐**每个亮度档位单独跑一条 run**。这样每条 run 的 `scenario` 就是该档位，分段更干净。

- 固定网络模式：建议选 Net-1（Wi‑Fi）或你实际最稳定的网络模式，并在整个 S2 序列保持一致。
- 亮度档位（最小 4 档）：建议 `30, 90, 150, 210`（0–255）。
- 每档时长：
  - 默认：12 分钟（前 2 分钟当过渡，可在分析时剔除）。
  - 若系统 UI 限制最大锁屏超时为 10 分钟，且 ADB 无法注入输入事件/无法修改 `screen_off_timeout`：改为 8–9 分钟/档（例如 540s），避免中途锁屏。

产出：拟合 `P_screen(brightness)`（线性或分段线性优先）；并给出每档均值与区间（例如窗口 bootstrap）。

验收：
- `adb_error=0`；
- `brightness` 在整条 run 内应为常数；
- thermal 不应出现持续上升且不稳定（否则把温度作为协变量建模）。

示例命名（scenario）：`S2_b30`、`S2_b90`、`S2_b150`、`S2_b210`。

若你的设备无法通过 ADB 写入亮度设置（WRITE_SETTINGS 受限），仍然可以严谨做 S2：
- 在手机上手动拖动亮度条到目标附近；
- 用 ADB 读取真实数值 `screen_brightness`（0–255）作为自变量；
- 推荐使用脚本自动按当前亮度命名并开跑：
  - `D:/workshop/MP_power/.venv/Scripts/python.exe scripts/s2_run_from_current_brightness.py --serial <serial> --duration 540 --thermal --auto-reset-battery`

在一些机型上，可以通过 AppOps 允许 shell 写设置，从而实现“用 ADB 设定亮度/超时”（更省手工操作）：
- `adb shell appops set com.android.shell WRITE_SETTINGS allow`
对应脚本参数示例：
- `D:/workshop/MP_power/.venv/Scripts/python.exe scripts/s2_run_from_current_brightness.py --serial <serial> --enable-write-settings --set-timeout-ms 1800000 --set-brightness 90 --duration 540 --thermal --auto-reset-battery`

---

### S3：CPU 负载（必做，量级校准，20–30 分钟）

- 目的：把 `time_in_state + power_profile` 的 CPU 解释器与真实放电对齐，得到 CPU 缩放系数 `k_cpu`（或残差上界）。
- 设计：两段（建议同一条 run 内，或拆成两条短 run）：
  - idle：10–15 分钟（屏幕关或最低亮度，保持不操作）
  - load：10–15 分钟（固定负载，例如循环计算/本地 benchmark；以“可复现”为准）

### S4：GPS 使用（必做，量级识别，20–30 分钟）

- 目的：得到 `P_gps` 的量级，支撑题面中 GPS 场景与建议。
- 设计：两段（同上，可一条 run 或两条短 run）：
  - GPS off：10–15 分钟
  - GPS on：10–15 分钟（打开定位/导航 app，尽量保持前台不变）

### V1：验证（必做，30–45 分钟）

- 目的：用校准得到的参数去预测一个“混合使用脚本”，并报告误差与不确定性（题面第2条）。
- 设计：1 条 run，包含至少两种驱动变化（例如亮度中档 + Wi‑Fi + 周期性 GPS on/off）。
- 验收：同 S0，且事件记录清晰（Run Sheet）。

---

## 3. 每条 run 的执行清单（Run Sheet）

复制下列模板到每条实验的 note 或单独文件：

- run_id：
- scenario：
- 目标：
- 组网拓扑（Topo-1/Topo-2）：
- 网络模式（Net-0/Net-1/Net-2）：
- 屏幕：on/off；亮度计划：
- 固定开关：热点/蓝牙/GPS/省电/高刷：
- 开始前：等待静置 X 分钟；thermal_status= ；battery_updates_stopped=0（是/否）
- 过程中事件（时间点 + 事件）：
- 结束后：是否有 adb_error；是否出现异常温升；备注

### 3.1 建议的命令模板（统一口径）

除非需要指定设备，`--serial` 可省略（脚本会优先选择无线设备）。

- 采样 + enrich + report（推荐）：
  - `D:/workshop/MP_power/.venv/Scripts/python.exe scripts/pipeline_run.py --scenario <SCENARIO> --duration <SECONDS> --interval 2 --thermal --display --auto-reset-battery --log-every 30 --qc`
- 质量自检（跑完立刻做）：
  - `D:/workshop/MP_power/.venv/Scripts/python.exe qc/qc_run.py --csv artifacts/runs/<run>_enriched.csv`
  - （可选）如果只想生成报告而不重跑采样：`D:/workshop/MP_power/.venv/Scripts/python.exe scripts/pipeline_run.py --skip-sample --run-csv artifacts/runs/<run>.csv --scenario <label>`

备注：`pipeline_run.py` 默认启用 Perfetto `android.power`（高频电池 counters，默认 250ms）。如需显式关闭：`--no-perfetto-android-power`（不推荐用于正式数据）。

备注：当你怀疑“是否中途熄屏/是否真的保持 ON”时，建议加 `--display`，它会在 CSV 中记录 `display_state`（来自 `dumpsys power`）。

---

## 4. 验收与剔除规则（统一口径）

- 硬剔除：
  - `adb_error` 非空的行；
  - `battery_updates_stopped=1` 的区间（除非能 reset 并恢复）。
- 软剔除：
  - 场景切换后的前 60–120 秒（过渡）；
  - 出现明显温度漂移的区间（例如 battery/skin 单调上升且未稳定）。

备注：charge_counter 在短间隔下可能“量化为 0”，因此每档/每个统计窗口建议 ≥120 秒。

---

## 5. 受限场景：必须使用手机热点（Topo-1 固定）怎么办？

当电脑由于不可抗拒的网络因素无法接入路由器/单位网络，且你又必须依赖无线调试时，
“手机开启热点、电脑连接手机热点（Topo-1）”是一个**可接受**且可复现的实验条件。

关键处理原则：
- 不把“热点是否开启”当作要无限对照的噪声源，而是把它当作实验的**固定背景条件**（写入 Run Sheet）。
- 在这一前提下，仍然可以严谨地估计 `P_screen`、`k_cpu`、`P_gps` 等关键项；网络项则定义为 `P_net(Hotspot)` 这一状态。

补充约束（非常重要）：无线调试本质是 ADB 走 Wi‑Fi/IP 网络，因此**Wi‑Fi（或热点的 WLAN 接口）必须保持开启**。这意味着：
- 不能在保持无线调试连接的同时把 Wi‑Fi 总开关关掉；
- 但可以通过“飞行模式 + 手动重新打开 Wi‑Fi”的方式近似实现“无蜂窝”的网络状态（不同机型表现略有差异，以实际设置为准）。

### 5.1 题面“网络模式”如何覆盖？

在 Topo-1 固定时，严格意义上的 Net-0（飞行且无 Wi‑Fi）不可做（无线调试会断）。此外，Net-1/Net-2 的区分也会混杂（热点常以蜂窝为上行）。
这不等于无法贴题，建议把网络状态定义成“可操作且可复现”的几档：

- `Net-HS`：热点开启 + 电脑连接（Topo-1 的默认网络背景）。
- `Net-HS-DataOff`（若可行）：保持热点与无线调试，但关闭“移动数据”或让电脑端保持几乎零流量（用于估计尾耗/维持连接背景）。
- `Net-AW`：飞行模式开启 + 手动重新打开 Wi‑Fi（或连接到电脑热点/无互联网 Wi‑Fi），用于近似“无蜂窝”情景。

对应到 S1 基线：
- S1-HS：屏幕关 + Net-HS（15–20 min）。
- （可选）S1-AW：屏幕关 + Net-AW（15–20 min），作为“无蜂窝”的对照；注意这不是必须项，只有当你后续要严谨区分蜂窝影响时才需要。

如需在报告中讨论 Wi‑Fi vs 蜂窝差异但本地无法实测，可采用：
- 少量已发表测量/规格数据给出量级对比（需引用与参数说明）；
- 或用模型做情景推演（以 `P_net` 的区间假设/敏感性分析呈现），并明确这是假设驱动的外推。

### 5.2 热点条件下如何降低方差（强推荐）

- 电脑端：把当前 Wi‑Fi 设为“按流量计费”，关闭系统更新/OneDrive/同步盘/浏览器后台刷新。
- 手机端：不进行任何前台操作；保持放置位置不变，避免信号强弱剧烈变化（蜂窝信号变化会显著影响功耗）。
- 热点连接：尽量只连接这一台电脑，避免其他设备蹭网造成流量与功耗波动。
- 分析时：采用 ≥120s 的窗口均值/滚动均值，而不是逐行瞬时功率。

### 5.3 在 Topo-1 固定下的 v1 最小集合（替代版）

- S0：仪器自检（同前）
- S1-HS：屏幕关 + Net-HS（15–20 min）
- （可选）S1-AW：屏幕关 + Net-AW（15–20 min）
- S2：亮度档位短 run（同前）
- S3：CPU 两段（同前）
- S4：GPS 两段（同前）
- V1：混合脚本验证（同前）
